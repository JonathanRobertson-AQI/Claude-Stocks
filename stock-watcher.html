<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Watcher</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10; --surface: #111318; --surface2: #181b22; --border: #1e2330;
    --text: #e8eaf0; --muted: #5a6178; --green: #00e5a0; --red: #ff4d6a;
    --yellow: #f5c842; --blue: #4d9fff; --accent: #00e5a0;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; padding: 24px; }

  /* API Banner */
  #apiSetup {
    background: var(--surface); border: 1px solid var(--yellow); border-radius: 14px;
    padding: 20px 24px; margin-bottom: 28px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  }
  #apiSetup.hidden { display: none; }
  .api-icon { font-size: 1.4rem; }
  .api-text { flex: 1; min-width: 200px; }
  .api-text h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; }
  .api-text p { font-size: 0.77rem; color: var(--muted); line-height: 1.5; }
  .api-text a { color: var(--yellow); text-decoration: none; }
  .api-text a:hover { text-decoration: underline; }
  .api-input-row { display: flex; gap: 8px; flex-wrap: wrap; }
  #apiKeyInput {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); padding: 9px 14px; font-family: 'Space Mono', monospace;
    font-size: 0.78rem; width: 260px; outline: none; transition: border-color 0.2s;
  }
  #apiKeyInput:focus { border-color: var(--yellow); }
  .btn-yellow {
    background: var(--yellow); color: #000; border: none; border-radius: 8px;
    padding: 9px 18px; font-family: 'DM Sans', sans-serif; font-weight: 600;
    font-size: 0.82rem; cursor: pointer; transition: opacity 0.15s; white-space: nowrap;
  }
  .btn-yellow:hover { opacity: 0.85; }

  header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 28px; padding-bottom: 16px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px;
  }
  .logo { font-family: 'Space Mono', monospace; font-size: 1.1rem; color: var(--accent); }
  .header-right { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .live-badge { display: flex; align-items: center; gap: 6px; font-size: 0.72rem; color: var(--muted); font-family: 'Space Mono', monospace; text-transform: uppercase; letter-spacing: 0.08em; }
  .pulse { width: 7px; height: 7px; background: var(--green); border-radius: 50%; animation: pulse 1.4s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.7)} }
  .data-mode { font-size: 0.7rem; font-family: 'Space Mono', monospace; padding: 4px 10px; border-radius: 5px; letter-spacing: 0.05em; }
  .data-mode.live { background: rgba(0,229,160,0.1); color: var(--green); border: 1px solid rgba(0,229,160,0.25); }
  .data-mode.simulated { background: rgba(90,97,120,0.12); color: var(--muted); border: 1px solid rgba(90,97,120,0.2); }
  .btn-link { background: none; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 6px 12px; font-size: 0.75rem; cursor: pointer; transition: color 0.15s, border-color 0.15s; }
  .btn-link:hover { color: var(--red); border-color: var(--red); }

  .add-row { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
  input[type="text"] {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); padding: 10px 14px; font-family: 'Space Mono', monospace;
    font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.06em; width: 140px; outline: none; transition: border-color 0.2s;
  }
  input[type="text"]:focus { border-color: var(--accent); }
  .btn-add { background: var(--accent); color: #000; border: none; border-radius: 8px; padding: 10px 20px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: opacity 0.15s, transform 0.1s; }
  .btn-add:hover { opacity: 0.85; }
  .btn-add:active { transform: scale(0.97); }
  .btn-refresh { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); border-radius: 8px; padding: 10px 16px; font-size: 0.82rem; cursor: pointer; transition: color 0.15s; }
  .btn-refresh:hover { color: var(--text); }
  .btn-refresh.spinning { display: inline-block; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; margin-bottom: 28px; }

  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
    padding: 18px 20px; position: relative; overflow: hidden; transition: border-color 0.3s; animation: fadeIn 0.35s ease;
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  .card.signal-buy { border-color: var(--green); }
  .card.signal-sell { border-color: var(--red); }

  .card-glow { position: absolute; top: 0; left: 0; right: 0; height: 2px; border-radius: 14px 14px 0 0; opacity: 0; transition: opacity 0.4s; }
  .card.signal-buy .card-glow { background: var(--green); opacity: 1; }
  .card.signal-sell .card-glow { background: var(--red); opacity: 1; }

  .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .ticker { font-family: 'Space Mono', monospace; font-size: 1.2rem; font-weight: 700; }
  .company-name { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
  .card-actions { display: flex; align-items: center; gap: 6px; }
  .source-tag { font-size: 0.62rem; font-family: 'Space Mono', monospace; padding: 2px 7px; border-radius: 4px; letter-spacing: 0.04em; }
  .source-tag.live { background: rgba(0,229,160,0.1); color: var(--green); }
  .source-tag.sim { background: rgba(90,97,120,0.1); color: var(--muted); }
  .remove-btn { background: none; color: var(--muted); padding: 2px 6px; font-size: 1rem; border-radius: 4px; border: none; cursor: pointer; }
  .remove-btn:hover { color: var(--red); }

  .price-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 3px; }
  .price { font-family: 'Space Mono', monospace; font-size: 1.7rem; font-weight: 700; letter-spacing: -0.03em; }
  .change { font-size: 0.85rem; font-weight: 500; padding: 2px 7px; border-radius: 5px; }
  .change.up { background: rgba(0,229,160,0.12); color: var(--green); }
  .change.down { background: rgba(255,77,106,0.12); color: var(--red); }
  .last-updated { font-size: 0.67rem; color: var(--muted); margin-bottom: 8px; font-family: 'Space Mono', monospace; }

  .sparkline { width: 100%; height: 50px; margin: 10px 0; }

  .metrics { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 14px; }
  .metric { background: var(--surface2); border-radius: 8px; padding: 8px 10px; }
  .metric-label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.07em; font-family: 'Space Mono', monospace; margin-bottom: 3px; }
  .metric-value { font-family: 'Space Mono', monospace; font-size: 0.82rem; font-weight: 700; }
  .rsi-bar { width: 100%; height: 4px; background: var(--surface2); border-radius: 2px; margin-top: 4px; overflow: hidden; }
  .rsi-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

  .signal-badge { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.04em; text-transform: uppercase; font-family: 'Space Mono', monospace; }
  .signal-badge.buy { background: rgba(0,229,160,0.15); color: var(--green); border: 1px solid rgba(0,229,160,0.3); }
  .signal-badge.sell { background: rgba(255,77,106,0.15); color: var(--red); border: 1px solid rgba(255,77,106,0.3); }
  .signal-badge.hold { background: rgba(90,97,120,0.15); color: var(--muted); border: 1px solid rgba(90,97,120,0.2); }
  .signal-badge.watch { background: rgba(245,200,66,0.12); color: var(--yellow); border: 1px solid rgba(245,200,66,0.25); }
  .signal-reason { font-size: 0.72rem; color: var(--muted); margin-top: 6px; line-height: 1.4; }
  .error-tag { font-size: 0.7rem; color: var(--red); margin-top: 6px; line-height: 1.4; }

  .empty-state { padding: 40px; text-align: center; color: var(--muted); font-size: 0.85rem; grid-column: 1 / -1; }

  .alerts-section h2 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); font-family: 'Space Mono', monospace; margin-bottom: 12px; }
  .alerts-log { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; max-height: 200px; overflow-y: auto; padding: 4px 0; }
  .alert-item { display: flex; align-items: center; gap: 12px; padding: 8px 16px; border-bottom: 1px solid var(--border); font-size: 0.8rem; animation: fadeIn 0.3s ease; }
  .alert-item:last-child { border-bottom: none; }
  .alert-time { font-family: 'Space Mono', monospace; color: var(--muted); font-size: 0.7rem; min-width: 60px; }
  .alert-ticker { font-family: 'Space Mono', monospace; font-weight: 700; min-width: 50px; }
  .alert-msg { flex: 1; color: var(--muted); }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ API Key Banner ‚îÄ‚îÄ -->
<div id="apiSetup">
  <div class="api-icon">üîë</div>
  <div class="api-text">
    <h3>Connect your Polygon.io / Massive API key</h3>
    <p>Get a free key at <a href="https://polygon.io" target="_blank">polygon.io</a> ‚Üí Sign up ‚Üí Dashboard ‚Üí API Keys.
    Free tier gives 15-min delayed quotes + full daily history. Your key is saved only in your browser (localStorage).</p>
  </div>
  <div class="api-input-row">
    <input id="apiKeyInput" type="text" placeholder="Paste API key here" style="text-transform:none;letter-spacing:0.02em;width:260px" />
    <button class="btn-yellow" onclick="saveApiKey()">Save Key</button>
  </div>
</div>

<header>
  <div class="logo">‚óà stockwatch</div>
  <div class="header-right">
    <span class="data-mode simulated" id="dataModeBadge">‚óè SIMULATED</span>
    <div class="live-badge"><div class="pulse"></div> auto-refresh 60s</div>
    <button class="btn-link" id="clearKeyBtn" style="display:none" onclick="clearApiKey()">Change API Key</button>
  </div>
</header>

<div class="add-row">
  <input type="text" id="tickerInput" placeholder="TICKER" maxlength="6" />
  <button class="btn-add" onclick="addStock()">+ Add Stock</button>
  <button class="btn-refresh" id="refreshBtn" onclick="refreshAll()">‚Üª Refresh</button>
</div>

<div class="cards" id="cardsGrid">
  <div class="empty-state" id="emptyState">Add a ticker above to start watching</div>
</div>

<div class="alerts-section">
  <h2>Alert Log</h2>
  <div class="alerts-log" id="alertsLog">
    <div class="alert-item"><span style="width:100%;color:var(--muted);font-size:0.75rem;text-align:center;padding:6px 0">No alerts yet</span></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const POLYGON_BASE = 'https://api.polygon.io';
const REFRESH_MS = 60_000;

let apiKey = localStorage.getItem('polygon_api_key') || '';
const stocks = {};

// ‚îÄ‚îÄ API Key UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveApiKey() {
  const val = document.getElementById('apiKeyInput').value.trim();
  if (!val) return;
  apiKey = val;
  localStorage.setItem('polygon_api_key', apiKey);
  applyKeyUI();
  refreshAll();
}

function clearApiKey() {
  apiKey = '';
  localStorage.removeItem('polygon_api_key');
  applyKeyUI();
  Object.keys(stocks).forEach(t => { if (stocks[t]) { stocks[t].source = 'sim'; renderCard(t); } });
}

function applyKeyUI() {
  const has = !!apiKey;
  document.getElementById('apiSetup').classList.toggle('hidden', has);
  document.getElementById('clearKeyBtn').style.display = has ? 'block' : 'none';
  const b = document.getElementById('dataModeBadge');
  b.textContent = has ? '‚óè LIVE (15m delay)' : '‚óè SIMULATED';
  b.className = 'data-mode ' + (has ? 'live' : 'simulated');
}

// ‚îÄ‚îÄ Polygon API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchSnapshot(ticker) {
  const r = await fetch(`${POLYGON_BASE}/v2/snapshot/locale/us/markets/stocks/tickers/${ticker}?apiKey=${apiKey}`);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const j = await r.json();
  if (!j.ticker) throw new Error(j.error || 'No snapshot data');
  return j.ticker;
}

async function fetchHistory(ticker) {
  const to = new Date().toISOString().slice(0, 10);
  const from = new Date(Date.now() - 60 * 86400_000).toISOString().slice(0, 10);
  const r = await fetch(`${POLYGON_BASE}/v2/aggs/ticker/${ticker}/range/1/day/${from}/${to}?adjusted=true&sort=asc&limit=50&apiKey=${apiKey}`);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const j = await r.json();
  if (!j.results?.length) throw new Error('No history data');
  return j.results.map(c => c.c);
}

// ‚îÄ‚îÄ Simulation fallback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MOCK = { AAPL:189.5, MSFT:415.2, TSLA:248.7, NVDA:875.4, GOOGL:171.6, AMZN:195.8, META:518.3, AMD:162.4, NFLX:641.2, SPY:512.8, QQQ:442.5 };

function simulateStock(ticker) {
  const base = MOCK[ticker] || (50 + Math.random() * 450);
  const history = [];
  let p = base * 0.94;
  for (let i = 0; i < 30; i++) { p *= 1 + (Math.random() - 0.499) * 0.012; history.push(p); }
  const price = history.at(-1), prev = history.at(-2);
  return { price, prevClose: prev, changePerc: ((price - prev) / prev) * 100, history, source: 'sim', error: null };
}

// ‚îÄ‚îÄ Signal logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcRSI(prices, n = 14) {
  if (prices.length < n + 1) return 50;
  let g = 0, l = 0;
  for (let i = prices.length - n; i < prices.length; i++) {
    const d = prices[i] - prices[i - 1];
    d > 0 ? g += d : l -= d;
  }
  if (l === 0) return 100;
  return 100 - 100 / (1 + g / n / (l / n));
}
function calcSMA(prices, n) {
  const s = prices.slice(-n);
  return s.reduce((a, b) => a + b, 0) / s.length;
}
function getSignal(history) {
  const rsi = calcRSI(history), sma9 = calcSMA(history, 9), sma20 = calcSMA(history, 20);
  const price = history.at(-1), reasons = [];
  let score = 0;
  if (rsi < 30) { score += 2; reasons.push(`RSI oversold (${rsi.toFixed(0)})`); }
  else if (rsi < 40) { score += 1; reasons.push(`RSI low (${rsi.toFixed(0)})`); }
  else if (rsi > 70) { score -= 2; reasons.push(`RSI overbought (${rsi.toFixed(0)})`); }
  else if (rsi > 60) { score -= 1; reasons.push(`RSI elevated (${rsi.toFixed(0)})`); }
  if (sma9 > sma20 * 1.005 && price > sma9) { score++; reasons.push('Bullish MA cross'); }
  else if (sma9 < sma20 * 0.995 && price < sma9) { score--; reasons.push('Bearish MA cross'); }
  const m = (history.at(-1) - history.at(-5)) / history.at(-5);
  if (m > 0.015) { score--; reasons.push('Sharp recent rise'); }
  else if (m < -0.015) { score++; reasons.push('Sharp recent drop'); }
  if (score >= 2) return { signal: 'buy', label: '‚ñ≤ Buy Signal', reasons };
  if (score <= -2) return { signal: 'sell', label: '‚ñº Sell Signal', reasons };
  if (score === 1) return { signal: 'watch', label: '‚óé Watch ‚Äî Leaning Buy', reasons };
  if (score === -1) return { signal: 'watch', label: '‚óé Watch ‚Äî Leaning Sell', reasons };
  return { signal: 'hold', label: '‚Äî Hold', reasons };
}

// ‚îÄ‚îÄ Sparkline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawSparkline(canvas, history, signal) {
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth || 280, H = canvas.height;
  ctx.clearRect(0, 0, W, H);
  const min = Math.min(...history), max = Math.max(...history), range = max - min || 1;
  const color = signal === 'buy' ? '#00e5a0' : signal === 'sell' ? '#ff4d6a' : '#4d9fff';
  ctx.beginPath();
  history.forEach((p, i) => {
    const x = i / (history.length - 1) * W;
    const y = H - (p - min) / range * H * 0.85 - H * 0.05;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.stroke();
  ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
  const g = ctx.createLinearGradient(0, 0, 0, H);
  g.addColorStop(0, color + '33'); g.addColorStop(1, color + '00');
  ctx.fillStyle = g; ctx.fill();
}

function fmt(n) { return n >= 1000 ? n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : n.toFixed(2); }

// ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ensureCard(ticker) {
  let card = document.getElementById('card-' + ticker);
  if (card) return card;
  card = document.createElement('div');
  card.id = 'card-' + ticker;
  card.innerHTML = `
    <div class="card-glow"></div>
    <div class="card-header">
      <div><div class="ticker">${ticker}</div><div class="company-name" id="name-${ticker}"></div></div>
      <div class="card-actions">
        <span class="source-tag sim" id="src-${ticker}">SIM</span>
        <button class="remove-btn" onclick="removeStock('${ticker}')">‚úï</button>
      </div>
    </div>
    <div class="price-row">
      <span class="price" id="price-${ticker}">‚Äî</span>
      <span class="change" id="change-${ticker}"></span>
    </div>
    <div class="last-updated" id="updated-${ticker}"></div>
    <canvas class="sparkline" id="spark-${ticker}" height="50"></canvas>
    <div class="metrics">
      <div class="metric"><div class="metric-label">RSI</div><div class="metric-value" id="rsi-${ticker}">‚Äî</div><div class="rsi-bar"><div class="rsi-fill" id="rsibar-${ticker}"></div></div></div>
      <div class="metric"><div class="metric-label">SMA9</div><div class="metric-value" id="sma9-${ticker}">‚Äî</div></div>
      <div class="metric"><div class="metric-label">SMA20</div><div class="metric-value" id="sma20-${ticker}">‚Äî</div></div>
    </div>
    <div id="signal-${ticker}"></div>
    <div class="signal-reason" id="reason-${ticker}"></div>
    <div class="error-tag" id="error-${ticker}"></div>
  `;
  document.getElementById('cardsGrid').appendChild(card);
  document.getElementById('emptyState')?.remove();
  return card;
}

function renderCard(ticker) {
  const s = stocks[ticker]; if (!s) return;
  const card = ensureCard(ticker);
  const { signal, label, reasons } = getSignal(s.history);
  const prev = s._lastSignal;
  if (prev && signal !== prev && (signal === 'buy' || signal === 'sell')) addAlert(ticker, signal, s.price);
  s._lastSignal = signal;
  card.className = `card signal-${signal}`;

  document.getElementById('price-' + ticker).textContent = '$' + fmt(s.price);
  const ce = document.getElementById('change-' + ticker);
  ce.textContent = (s.changePerc >= 0 ? '+' : '') + s.changePerc.toFixed(2) + '%';
  ce.className = 'change ' + (s.changePerc >= 0 ? 'up' : 'down');

  const src = document.getElementById('src-' + ticker);
  src.textContent = s.source === 'live' ? 'LIVE' : 'SIM';
  src.className = 'source-tag ' + (s.source === 'live' ? 'live' : 'sim');

  if (s.updatedAt) document.getElementById('updated-' + ticker).textContent = 'Updated ' + s.updatedAt;

  const rsi = calcRSI(s.history), sma9 = calcSMA(s.history, 9), sma20 = calcSMA(s.history, 20);
  document.getElementById('rsi-' + ticker).textContent = rsi.toFixed(1);
  const rb = document.getElementById('rsibar-' + ticker);
  rb.style.width = rsi + '%';
  rb.style.background = rsi < 30 ? 'var(--green)' : rsi > 70 ? 'var(--red)' : 'var(--blue)';
  document.getElementById('sma9-' + ticker).textContent = '$' + sma9.toFixed(2);
  document.getElementById('sma20-' + ticker).textContent = '$' + sma20.toFixed(2);
  document.getElementById('signal-' + ticker).innerHTML = `<span class="signal-badge ${signal}">${label}</span>`;
  document.getElementById('reason-' + ticker).textContent = reasons.join(' ¬∑ ');
  document.getElementById('error-' + ticker).textContent = s.error || '';

  const cv = document.getElementById('spark-' + ticker);
  drawSparkline(cv, s.history, signal);
}

// ‚îÄ‚îÄ Load / refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStock(ticker) {
  ensureCard(ticker);
  if (!apiKey) {
    stocks[ticker] = { ...simulateStock(ticker), _lastSignal: stocks[ticker]?._lastSignal ?? null };
    renderCard(ticker); return;
  }
  try {
    const [snap, hist] = await Promise.all([fetchSnapshot(ticker), fetchHistory(ticker)]);
    const price = snap.lastTrade?.p || snap.day?.c || snap.prevDay?.c;
    const prev = snap.prevDay?.c || hist.at(-2);
    const changePerc = snap.todaysChangePerc ?? ((price - prev) / prev * 100);
    const fullHistory = [...hist];
    if (price && price !== fullHistory.at(-1)) fullHistory.push(price);
    stocks[ticker] = {
      price, prevClose: prev, changePerc, history: fullHistory,
      source: 'live', updatedAt: new Date().toLocaleTimeString(), error: null,
      _lastSignal: stocks[ticker]?._lastSignal ?? null
    };
  } catch (err) {
    console.warn(ticker, err.message);
    if (!stocks[ticker]?.history) stocks[ticker] = { ...simulateStock(ticker), _lastSignal: null };
    stocks[ticker].error = `‚ö† API: ${err.message} ‚Äî showing simulated data`;
    stocks[ticker].source = 'sim';
  }
  renderCard(ticker);
}

async function addStock() {
  const inp = document.getElementById('tickerInput');
  const ticker = inp.value.trim().toUpperCase();
  if (!ticker || stocks[ticker]) { inp.value = ''; return; }
  stocks[ticker] = null;
  inp.value = '';
  await loadStock(ticker);
}

function removeStock(ticker) {
  delete stocks[ticker];
  document.getElementById('card-' + ticker)?.remove();
  if (!Object.keys(stocks).length) {
    const g = document.getElementById('cardsGrid');
    if (!document.getElementById('emptyState')) {
      const e = document.createElement('div');
      e.id = 'emptyState'; e.className = 'empty-state';
      e.textContent = 'Add a ticker above to start watching';
      g.appendChild(e);
    }
  }
}

async function refreshAll() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  await Promise.all(Object.keys(stocks).map(loadStock));
  btn.classList.remove('spinning');
}

function addAlert(ticker, signal, price) {
  const time = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const color = signal === 'buy' ? 'var(--green)' : 'var(--red)';
  const msg = `${signal === 'buy' ? 'Buy' : 'Sell'} signal triggered at $${fmt(price)}`;
  const log = document.getElementById('alertsLog');
  if (log.querySelector('span[style*="100%"]')) log.innerHTML = '';
  const item = document.createElement('div');
  item.className = 'alert-item';
  item.innerHTML = `<span class="alert-time">${time}</span><span class="alert-ticker" style="color:${color}">${ticker}</span><span class="alert-msg">${msg}</span>`;
  log.prepend(item);
  if (log.children.length > 30) log.removeChild(log.lastChild);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('tickerInput').addEventListener('keydown', e => { if (e.key === 'Enter') addStock(); });
document.getElementById('apiKeyInput').addEventListener('keydown', e => { if (e.key === 'Enter') saveApiKey(); });

if (apiKey) document.getElementById('apiKeyInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
applyKeyUI();

['AAPL', 'NVDA', 'TSLA'].forEach(t => { stocks[t] = null; loadStock(t); });
setInterval(refreshAll, REFRESH_MS);
</script>
</body>
</html>